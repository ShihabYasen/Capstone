import streamlit as st
from streamlit_chat import message
import time
from llama_index import VectorStoreIndex, ServiceContext
from llama_index.llms import OpenAI
from llama_index import SimpleDirectoryReader
import openai
import time
import os
from cryptography.fernet import Fernet



# Load the encryption key from the file
with open("encryption_key.key", "rb") as key_file:
    key = key_file.read()

# Create a Fernet cipher object with the loaded key
cipher = Fernet(key)

# Function to decrypt a file
def decrypt_file(encrypted_file_path, cipher):
    with open(encrypted_file_path, 'rb') as file:
        encrypted_data = file.read()
    decrypted_data = cipher.decrypt(encrypted_data)
    decrypted_file_path = encrypted_file_path[:-len('.encrypted')]  # Remove the '.encrypted' extension
    with open(decrypted_file_path, 'wb') as decrypted_file:
        decrypted_file.write(decrypted_data)
    os.remove(encrypted_file_path)   

directory = r'Industial data draft'

for root, dirs, files in os.walk(directory):
    for file in files:
        if file.endswith('.encrypted'):
            encrypted_file_path = os.path.join(root, file)
            decrypt_file(encrypted_file_path, cipher)




cooldown_duration = 1

def check_terms_and_conditions():    

    st.markdown('''
            *Introduction:*\n
            Welcome to the SCL System Customer Service Chatbot! Before you engage with our chatbot, please take a moment to review and understand the following terms and conditions. Your use of the chatbot implies your agreement to comply with these terms.

            *Capabilities:*
            1. *Informational Assistance:* The chatbot is designed to offer information and assistance related to our products and services.
            2. *Query Resolution:* It can help address common queries, guide you through processes, and provide relevant information.
            3. *Limited Personalization:* The chatbot may use minimal personal information to enhance user experience but does not store or process sensitive data.

            *Restrictions:*
            1. *No Legal Advice:* The chatbot does not provide legal advice or opinions. For legal matters, consult a professional.
            2. *Limited Scope:* The chatbot's capabilities are confined to predefined tasks and information related to our products and services.
            3. *No Financial Transactions:* The chatbot does not facilitate or process financial transactions. Please use our official channels for such transactions.

            *Data Usage and Privacy:*
            1. *Data Collection:* The chatbot may collect limited personal information to improve user experience and address queries. This data is handled according to our privacy policy.
            2. *Security Measures:* We employ security measures to safeguard the data collected by the chatbot. However, avoid sharing sensitive personal information.

            *Consent:*
            1. *Express Consent:* Before collecting any sensitive data or using it beyond the chatbot's scope, we will seek your express consent.
            2. *Opt-out Option:* You can opt-out of sharing information or terminate the chat at any time.

            *Liability:*
            1. *No Guarantees:* While the chatbot aims for accuracy, we do not guarantee its completeness or accuracy.
            2. *Limited Liability:* We are not liable for any loss or damage resulting from the use of the chatbot.

            Link Warning:
            Warning: The link generated by the chatbot is provided without liability.             

            *Termination:*
            We reserve the right to terminate or suspend chatbot services without notice.

            *Updates:*
            These terms and conditions may be updated periodically. Your continued use of the chatbot implies acceptance of the latest version.

            By using our Customer Service Chatbot, you acknowledge that you have read, understood, and agreed to these terms and conditions. 
            If you disagree, please refrain from using the chatbot. For questions or concerns, contact our customer support through official channels.

            Contact Us:\n
            SCL System Enterprise Pte Ltd,
            41 Jalan Pemimpin,
            #02-01A Kong Beng Industrial Building,
            Singapore 577186

            Phone/WhatsApp: +65-62599968

            Fax: +65-62599282

            Email: sales@sclsystem.com.sg
                
            Website: https://www.sclsystem.com.sg/

            Copyright Â© 2023 SCL SystemTerms & Conditions | Privacy Policy
            ''')

    # Check if the user has agreed to the terms and conditions
    agreed_to_terms = st.checkbox("I have read and agreed to the Terms and Conditions")

    if agreed_to_terms:
        st.success("Thank you for agreeing to the Terms and Conditions. You can now access the chatbot.")
        return True
    else:
        st.warning("Please read and agree to the Terms and Conditions before accessing the chatbot.")
        return False

if check_terms_and_conditions():
    
    st.title("SCL System Customer Service Chatbot")

    with st.sidebar:
        st.title('ðŸ¤—ðŸ’¬ SCL System Customer Service Chatbot')

        # Create an expander widget for the terms and conditions
        with st.expander("Chatbot Terms and Conditions"):
            st.write('''
            *Introduction:*\n
            Welcome to the SCL System Customer Service Chatbot! Before you engage with our chatbot, please take a moment to review and understand the following terms and conditions. Your use of the chatbot implies your agreement to comply with these terms.

            *Capabilities:*
            1. *Informational Assistance:* The chatbot is designed to offer information and assistance related to our products and services.
            2. *Query Resolution:* It can help address common queries, guide you through processes, and provide relevant information.
            3. *Limited Personalization:* The chatbot may use minimal personal information to enhance user experience but does not store or process sensitive data.

            *Restrictions:*
            1. *No Legal Advice:* The chatbot does not provide legal advice or opinions. For legal matters, consult a professional.
            2. *Limited Scope:* The chatbot's capabilities are confined to predefined tasks and information related to our products and services.
            3. *No Financial Transactions:* The chatbot does not facilitate or process financial transactions. Please use our official channels for such transactions.

            *Data Usage and Privacy:*
            1. *Data Collection:* The chatbot may collect limited personal information to improve user experience and address queries. This data is handled according to our privacy policy.
            2. *Security Measures:* We employ security measures to safeguard the data collected by the chatbot. However, avoid sharing sensitive personal information.

            *Consent:*
            1. *Express Consent:* Before collecting any sensitive data or using it beyond the chatbot's scope, we will seek your express consent.
            2. *Opt-out Option:* You can opt-out of sharing information or terminate the chat at any time.

            *Liability:*
            1. *No Guarantees:* While the chatbot aims for accuracy, we do not guarantee its completeness or accuracy.
            2. *Limited Liability:* We are not liable for any loss or damage resulting from the use of the chatbot.

            Link Warning:
            Warning: The link generated by the chatbot is provided without liability.             

            *Termination:*
            We reserve the right to terminate or suspend chatbot services without notice.

            *Updates:*
            These terms and conditions may be updated periodically. Your continued use of the chatbot implies acceptance of the latest version.

            By using our Customer Service Chatbot, you acknowledge that you have read, understood, and agreed to these terms and conditions. 
            If you disagree, please refrain from using the chatbot. For questions or concerns, contact our customer support through official channels.

            Contact Us
            SCL System Enterprise Pte Ltd,
            41 Jalan Pemimpin,
            #02-01A Kong Beng Industrial Building,
            Singapore 577186

            Phone/WhatsApp: +65-62599968

            Fax: +65-62599282

            Email: sales@sclsystem.com.sg
                     
            Website: https://www.sclsystem.com.sg/

            Copyright Â© 2023 SCL SystemTerms & Conditions | Privacy Policy
            ''')
    

    with st.sidebar.expander('Products'):
        st.write("Our product is Enclosure Boxes")
        st.write("4 screws Type: S series")
        st.write("Hinge Type: P series")
        st.write("You are able to key in the Specification and Model and Size")




    with st.sidebar.expander("Contact Us"):
        st.title("SCL System Enterprise Pte Ltd")
        st.write("41 Jalan Pemimpin,")
        st.write("#02-01A Kong Beng Industrial Building,")
        st.write("Singapore 577186")
        
        st.subheader("Contact Details:")
        st.write("Phone/WhatsApp: +65-62599968")
        st.write("Fax: +65-62599282")
        st.write("Email: sales@sclsystem.com.sg")
        st.write('Website: https://www.sclsystem.com.sg/')



    openai.api_key = st.secrets["OPENAI_API_KEY"]

    if "messages" not in st.session_state.keys(): # Initialize the chat message history
        st.session_state.messages = [
            {"role": "assistant", "content": "Hi, I am Kafka, your personal assistant, ask me any question about SCL System Products!"}
        ]
        with st.expander("messages History"):
            st.session_state.prompt = ""

    @st.cache_resource(show_spinner=False)
    def load_data():
        with st.spinner(text="Loading and indexing the Streamlit docs â€“ hang tight! This should take a few seconds."):
            reader = SimpleDirectoryReader(input_dir=r"Industial data draft", recursive=True)
            docs = reader.load_data()
            service_context = ServiceContext.from_defaults(llm=OpenAI(model="gpt-3.5-turbo-16k", temperature=0.5, system_prompt=
            '''Your name is kafka. Kafka is a seasoned sales and customer service professional employed at SCL System Enterprise Pte Ltd. With 23 years of experience in the industrial control and automation components industry, she specializes in providing information and assistance related to the company's S series (4 Screw type) and P series (Hinge type) products. At SCL System Enterprise, Kafka's role revolves around understanding and fulfilling the unique requirements of clients. Her approach is characterized by technical expertise and a commitment to delivering accurate information sourced from reputable channels. Kafka ensures that her responses remain unbiased and focused on factual details, steering clear of any speculative or exaggerated claims about product features. In her interactions with clients, Kafka's priority is to assist them in identifying the most suitable solutions for their industrial control and automation needs. She achieves this by offering clear and concise technical information while guiding clients through their decision-making process. â€“ do not hallucinate features.'''))
            index = VectorStoreIndex.from_documents(docs, service_context=service_context)
            return index

    index = load_data()

    chat_engine = index.as_chat_engine(chat_mode="context", verbose=True)



        
    if prompt := st.chat_input("Your Inquries"): # Prompt for user input and save to chat history
        user = st.session_state.messages.append({"role": "user", "content": prompt})

        

    for message in st.session_state.messages: # Display the prior chat messages
        with st.chat_message(message["role"]):
            st.write(message["content"])
            

    # If last message is not from assistant, generate a new response
    if st.session_state.messages and st.session_state.messages[-1]["role"] != "assistant":
        with st.chat_message("assistant"):
            with st.spinner("Thinking..."):
                response = chat_engine.chat(prompt)
                st.write(response.response)
                message = {"role": "assistant", "content": response.response}
                st.session_state.messages.append(message)  # Add response to message history


    # Add a button to allow the user to chat log saving
    save_log_checkbox = st.button("Save Chat Log", key="save_log_checkbox")
    if save_log_checkbox:
        st.success("Saved Successfully!")
        time.sleep(cooldown_duration)
    # Create a placeholder for the chat log display
    chat_log_placeholder = st.empty()

    # Define the function to save chat logs individually
    def save_chat_log(messages):
        log_file_path = f"chat_log_{time.time()}.txt"  # Use a timestamp in the file name
        
        # Save the message to the file if the checkbox is selected
        if save_log_checkbox:
           with open(log_file_path, "w", encoding="utf-8") as log_file:
            for message in messages:
                log_file.write(f"Role: {message['role']}\n")
                log_file.write(f"Content: {message['content']}\n")
                log_file.write("\n")
            st.session_state.messages.append(message)  # Append a new message to the chat log
    save_chat_log(st.session_state.messages)

    def clear_chat_history():
        #if save_log_checkbox:  # Save chat log only if the checkbox is selected
            #save_chat_log(st.session_state.messages)

        st.session_state.messages = [
            {"role": "assistant", "content": "Hi, I am Kafka, your personal assistant, ask me any question about SCL System Products!"}
        ]

        st.session_state.prompt = ""
        st.session_state.generated = []
        


    clear_history = st.button("Clear History", key="clear_history", on_click=clear_chat_history)
    if clear_history:
        st.success("Chat history fully cleared.")
        time.sleep(cooldown_duration)
    

    with st.sidebar:
        st.title('Chatbot History')

        # Create an expander widget for the chat log history
        with st.expander("Chatbot History"):

            # Create a container for the chat log widget
            chat_log_widget = st.container()

            for message in st.session_state.messages:
                with chat_log_widget:  # Use the container for the chat log widget
                    with st.chat_message(message["role"]):
                        st.write(message["content"])

    def feedback_form():
            st.sidebar.subheader("Feedback Form")
            
            # Add form elements in the sidebar
            feedback_text = st.sidebar.text_area("Please provide your feedback here:")
            
            # Add a button to submit feedback in the sidebar
            if st.sidebar.button("Submit Feedback"):
                # You can process and save the feedback data here
                save_feedback(feedback_text)
                st.sidebar.success("Thank you for your feedback!")
                time.sleep(cooldown_duration)
                
    def save_feedback(feedback_text):
        # Define the file path to save feedback data as a TXT file
        feedback_file_path = "feedback_data.txt"
        
        # Open the file in append mode and write the feedback
        with open(feedback_file_path, "a", encoding="utf-8") as file:
            file.write(f"Feedback: {feedback_text}\n")

    # Call the function in your main code
    feedback_form()





